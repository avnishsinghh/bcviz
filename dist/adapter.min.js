/*! bcviz 1.3.1 - 2016/03/01 17:47:34 GMT | (c)2016 Genome Research Ltd */
define(["jquery","d3"],function(jQuery,d3){"use strict";function format_adapter_chart(data){var formattedData=[];for(var k in data.start_counts)formattedData.push({xVar:parseInt(k,10),yVar:data.start_counts[k]});return formattedData}function roundToPowerOfTen(aNumb){return Math.pow(10,Math.ceil(Math.log(aNumb)/Math.LN10))}function adapterChart(data,xMin,xMax,yMin,yMax,width,height,title){function make_x_grid(){return d3.svg.axis().scale(xScale).orient("bottom").ticks(10)}function make_y_grid(){return d3.svg.axis().scale(yScale).orient("left").ticks(10)}var w=width||500,h=height||250,padding={top:36,right:25,bottom:25,left:50},bare_svg=document.createElementNS(d3.ns.prefix.svg,"svg"),svg=d3.select(bare_svg).attr("width",w).attr("height",h);title&&svg.append("text").attr("transform","translate("+padding.left+", "+padding.top/4+")").style("font-size",padding.top/4).text(title);var n,nodeWidth=(w-padding.left-padding.right)/xMax,xScale=d3.scale.linear().nice().range([padding.left,w-padding.right]).domain([xMin,xMax]),yScale=d3.scale.log().clamp(!0).nice().range([h-padding.bottom,padding.top]),xAxis=d3.svg.axis().scale(xScale).orient("bottom").ticks(10),superscript="⁰¹²³⁴⁵⁶⁷⁸⁹",vArray=[];for(n=0;n<Math.log(yMax)/Math.LN10;n++)vArray.push(Math.pow(10,n));vArray.push(Math.pow(10,n));var yAxis=d3.svg.axis().scale(yScale).orient("left").tickValues(vArray).ticks(5,function(d){return d>=1?"10"+superscript[Math.round(Math.log(d)/Math.LN10)]:void 0});svg.append("g").attr("class","axis").attr("transform","translate(0,"+(h-padding.bottom)+")").call(xAxis),svg.append("text").attr("transform","translate("+(padding.left-5)+","+(h-padding.bottom+17)+")").text(data.min_isize),yScale.domain([yMin,yMax]),svg.append("g").attr("class","axis").attr("transform","translate("+padding.left+", 0)").call(yAxis),svg.append("g").attr("class","grid").attr("transform","translate(0,"+(h-padding.bottom)+")").call(make_x_grid().tickSize(-h+(padding.top+padding.bottom),0,0).tickFormat("")),svg.append("g").attr("class","grid").attr("id","yGrid").attr("transform","translate("+padding.left+",0)").call(make_y_grid().tickSize(-w+(padding.left+padding.right),0,0).tickFormat(""));var bars=svg.append("g");return bars.selectAll("rect").data(data.formattedData).enter().append("rect").attr("x",function(d){return xScale(d.xVar)}).attr("y",function(d){return yScale(d.yVar)}).attr("width",nodeWidth).attr("height",function(d){return h-padding.bottom-yScale(d.yVar)}).attr("fill","blue").attr("opacity",.6).attr("stroke-width","1px").attr("stroke","white"),svg}var drawChart=function(config){var svg_fwd,svg_rev,data=config.data,width=config.width,height=config.height,title=config.title||"";if(data&&"object"==typeof data){var mismatchData={};data.forward_fasta_read_count=+data.forward_fasta_read_count,data.reverse_fasta_read_count=+data.reverse_fasta_read_count;var forwardData=Object.create(mismatchData),reverseData=Object.create(mismatchData);forwardData.start_counts=data.forward_start_counts,reverseData.start_counts=data.reverse_start_counts,forwardData.formattedData=format_adapter_chart(forwardData),reverseData.formattedData=format_adapter_chart(reverseData),forwardData.yMax=roundToPowerOfTen(d3.max(forwardData.formattedData,function(d){return d.yVar})),isNaN(forwardData.yMax)&&(forwardData.yMax=0),reverseData.yMax=roundToPowerOfTen(d3.max(reverseData.formattedData,function(d){return d.yVar})),isNaN(reverseData.yMax)&&(reverseData.yMax=0);var xMin=d3.min(forwardData.formattedData.concat(reverseData.formattedData),function(d){return d.xVar}),xMax=d3.max(forwardData.formattedData.concat(reverseData.formattedData),function(d){return d.xVar}),yMin=.1,yMax=d3.max(forwardData.formattedData.concat(reverseData.formattedData),function(d){return d.yVar});yMax=roundToPowerOfTen(yMax),svg_fwd=adapterChart(forwardData,xMin,xMax,yMin,yMax,width,height,"Forward "+title),svg_rev=adapterChart(reverseData,xMin,xMax,yMin,yMax,width,height,"Reverse "+title),data.forward_fasta_read_count||(svg_fwd=null),data.reverse_fasta_read_count||(svg_rev=null)}return{svg_fwd:svg_fwd,svg_rev:svg_rev}};return{drawChart:drawChart,_formatChart:format_adapter_chart,_roundToPowerOfTen:roundToPowerOfTen}});