/*! bcviz 1.3.2 - 2016/04/07 16:19:48 GMT+0100 | (c)2016 Genome Research Ltd */
define(["jquery","d3"],function(jQuery,d3){"use strict";function histogram(data,width,height,title){function make_x_grid(){return d3.svg.axis().scale(xScale).orient("bottom").ticks(10)}function make_y_grid(){return d3.svg.axis().scale(yScale).orient("left").ticks(10)}width||(width=650),height||(height=300);var padding={top:50,right:25,bottom:25,left:50},bare_svg=document.createElementNS(d3.ns.prefix.svg,"svg"),svg=d3.select(bare_svg).attr("width",width).attr("height",height);svg.append("text").attr("transform","translate("+padding.left+", "+padding.top/4+")").style("font-size",padding.top/4).text(title),data.bin_width=+data.bin_width,data.min_isize=+data.min_isize,data.mean=+data.mean,data.std=+data.std,data.paired_reads_direction_in=+data.paired_reads_direction_in,data.num_well_aligned_reads_opp_dir=+data.num_well_aligned_reads_opp_dir,data.num_well_aligned_reads=+data.num_well_aligned_reads,data.bins.forEach(function(v,i,a){a[i]=+v});var xMin=data.min_isize,xMax=data.bins.length*data.bin_width+data.min_isize,yMin=0,yMax=d3.max(data.bins),nodeWidth=(width-padding.left-padding.right)/data.bins.length;xScale=d3.scale.linear().nice().range([padding.left,width-padding.right]).domain([xMin,xMax]),yScale=d3.scale.linear().nice().range([height-padding.bottom,padding.top]).domain([yMin,yMax]);var xAxis=d3.svg.axis().scale(xScale).orient("bottom").ticks(10).tickFormat(function(d){return 100==d&&xMin>50?"":d}),yAxis=d3.svg.axis().scale(yScale).orient("left").ticks(10);svg.append("g").attr("class","axis").attr("transform","translate("+padding.left+", 0)").call(yAxis),svg.append("g").attr("class","axis").attr("transform","translate(0,"+(height-padding.bottom)+")").call(xAxis),svg.append("text").attr("transform","translate("+(padding.left-5)+","+(height-padding.bottom+17)+")").text(data.min_isize),svg.append("g").attr("class","grid").attr("id","xGrid").attr("transform","translate(0,"+(height-padding.bottom)+")").call(make_x_grid().tickSize(-height+(padding.top+padding.bottom),0,0).tickFormat("")),svg.append("g").attr("class","grid").attr("id","yGrid").attr("transform","translate("+padding.left+",0)").call(make_y_grid().tickSize(-width+(padding.left+padding.right),0,0).tickFormat(""));var bars=svg.append("g");return bars.selectAll("rect").data(data.bins).enter().append("rect").attr("x",function(d,i){return xScale(i*data.bin_width+data.min_isize)}).attr("y",function(d){return yScale(d)}).attr("width",nodeWidth).attr("height",function(d){return height-padding.bottom-yScale(d)}).attr("fill",data.paired_reads_direction_in?"blue":"orange").attr("opacity",.6).attr("stroke-width","1px").attr("stroke","white"),data.norm_fit_modes&&drawStandardDistribution(data,svg),{svg:svg}}function drawStandardDistribution(data,svg){var mean=data.mean,std=data.std;data.norm_fit_modes.forEach(function(d){3==d.length&&(mean=d[1],std=d[2])});var norm=[];data.bins.forEach(function(v,i){var m=std*Math.sqrt(2*Math.PI),x=i*data.bin_width+data.min_isize,e=Math.exp(-(x-mean)*(x-mean)/(2*std*std)),n=e/m,point={x:i,y:n};norm.push(point)});var max_norm=0;norm.forEach(function(v){max_norm<v.y&&(max_norm=v.y)});var max_height=Math.max.apply(null,data.bins),scale=max_height/max_norm,lineFunc=d3.svg.line().x(function(d){return xScale(d.x*data.bin_width+data.min_isize)}).y(function(d){return yScale(d.y*scale)}).interpolate("basis");svg.append("svg:path").attr("d",lineFunc(norm)).attr("stroke","black").attr("stroke-width",2).attr("fill","none")}var xScale,yScale,drawChart=function(config){var data=config.data,width=config.width,height=config.height,title=config.title||"";return data&&"object"==typeof data&&null!=data.bins&&data.bins.length>1?histogram(data,width,height,title):null};return{drawChart:drawChart}});