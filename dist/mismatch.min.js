/*! bcviz 1.3.1 - 2016/01/08 13:34:48 GMT | (c)2016 Genome Research Ltd */
define(["jquery","d3"],function(jQuery,d3){"use strict";function formatMismatch(data){var barData=data.quality_bins,formattedData=[];if(!barData){if(barData=[],!data.errors)return{formattedData:formattedData,yMax:0};barData[0]=data.errors,data.n_count=[];for(var k=0;k<data.errors.length;k++)data.n_count[k]=0}barData.push(data.n_count);for(var yMax=0,i=0;i<barData[0].length;i++){for(var yVar=0,pushData=[],total=data.count[i],j=0;j<barData.length;j++)pushData.push({name:data.quality_bin_values[j],y0:yVar/total*100,y1:(barData[j][i]+yVar)/total*100}),yVar+=barData[j][i];pushData[barData.length-1].name="N",formattedData.push(pushData),yVar/total*100>yMax&&(yMax=yVar/total*100)}var returnVal={formattedData:formattedData,yMax:yMax};return returnVal}function mismatchPlot(data,xMin,xMax,yMin,yMax,w,h,title,colour){var padding={top:50,right:25,bottom:50,left:65},bare_svg=document.createElementNS(d3.ns.prefix.svg,"svg"),svg=d3.select(bare_svg).attr("width",w).attr("height",h);svg.append("text").attr("transform","translate("+padding.left+", "+padding.top/2+")").style("font-size",padding.top/4).text(title);var nodeWidth=(w-padding.left-padding.right)/xMax,xScale=d3.scale.linear().nice().range([padding.left,w-padding.right]).domain([xMin,xMax]),yScale=d3.scale.linear().nice().range([h-padding.bottom,padding.top]).domain([yMin,yMax]),xAxis=d3.svg.axis().scale(xScale).orient("bottom").ticks(10),yAxis=d3.svg.axis().scale(yScale).orient("left").ticks(10);if(svg.append("g").attr("class","axis").attr("transform","translate("+padding.left+", 0)").call(yAxis),svg.append("g").attr("class","axis").attr("transform","translate(0,"+(h-padding.bottom)+")").call(xAxis),!data.formattedData)return svg;var barGroup=svg.selectAll(".g").data(data.formattedData).enter().append("g").attr("transform",function(d,i){return"translate("+xScale(i)+",0)"}),forY=function(d){return yScale(d.y1)},forHeight=function(d){return yScale(d.y0)-yScale(d.y1)},forColour=function(d){return colour(d.name)};return barGroup.selectAll("rect").data(function(d){for(var temp=[],j=0;j<d.length;j++){var obj=d[j];obj.y0-obj.y1!==0&&temp.push(d[j])}return temp}).enter().append("rect").attr("width",nodeWidth).attr("y",forY).attr("height",forHeight).attr("stroke-width",1).attr("stroke","white").style("fill",forColour),svg}function draw_legend(h,colour){var bare_svg=document.createElementNS(d3.ns.prefix.svg,"svg"),legendSVG=d3.select(bare_svg).append("svg").attr("width",50).attr("height",h),legendPoints=legendSVG.selectAll(".legend").data(colour.domain()).enter().append("g").attr("class","legend");return legendPoints.append("rect").attr("y",function(d,i){return 15*i+h/2-30}).attr("width",10).attr("height",10).style("fill",colour),legendPoints.append("text").attr("x",25).attr("y",function(d,i){return 15*i+h/2-30}).attr("dy","10px").style("text-anchor","middle").text(function(d,i){return 0===i?">="+d:1===i?"=<"+d:2===i?"=<"+d:d}),legendSVG}var drawChart=function(config){var svg_fwd,svg_rev,svg_legend,colour,data=config.data,width=config.width||450,height=config.height||350,title=config.title||"",oldFormat=!1;if(data&&"object"==typeof data){var mismatchData={quality_bin_values:data.quality_bin_values};data.forward_aligned_read_count=+data.forward_aligned_read_count,data.reverse_aligned_read_count=+data.reverse_aligned_read_count;var forwardData=Object.create(mismatchData),reverseData=Object.create(mismatchData);forwardData.n_count=data.forward_n_count,forwardData.quality_bins=data.forward_quality_bins,forwardData.count=data.forward_count,forwardData.errors=data.forward_errors,reverseData.n_count=data.reverse_n_count,reverseData.quality_bins=data.reverse_quality_bins,reverseData.count=data.reverse_count,reverseData.errors=data.reverse_errors,data.quality_bin_values||(oldFormat=!0,forwardData.quality_bin_values=[0],reverseData.quality_bin_values=[0]);var forwardFormattedData=formatMismatch(forwardData);forwardFormattedData&&(forwardData.formattedData=forwardFormattedData.formattedData,forwardData.yMax=forwardFormattedData.yMax);var reverseFormattedData=formatMismatch(reverseData);reverseFormattedData&&(reverseData.formattedData=reverseFormattedData.formattedData,reverseData.yMax=reverseFormattedData.yMax),forwardFormattedData&&reverseFormattedData&&(forwardFormattedData.yMax>reverseFormattedData.yMax?(forwardData.yMax=forwardFormattedData.yMax,reverseData.yMax=forwardFormattedData.yMax):(forwardData.yMax=reverseFormattedData.yMax,reverseData.yMax=reverseFormattedData.yMax));var xMin=0,fwd_xMax=forwardData.quality_bins?forwardData.quality_bins[0].length:forwardData.count?forwardData.count.length:0,rev_xMax=reverseData.quality_bins?reverseData.quality_bins[0].length:reverseData.count?reverseData.count.length:0,xMax=d3.max([fwd_xMax,rev_xMax]),yMin=0,yMax=d3.max([forwardFormattedData.yMax,reverseFormattedData.yMax]);xMax=xMax||100,yMax=yMax||50,data.quality_bin_values=data.quality_bin_values||[],colour=oldFormat?d3.scale.ordinal().range(["black","blue"]).domain(data.quality_bin_values.concat("N")):d3.scale.ordinal().range(["rgb(8, 18, 247)","rgb(49, 246, 19)","rgb(236, 242, 28)","rgb(219, 68, 0)"]).domain(data.quality_bin_values.concat("N")),svg_fwd=mismatchPlot(forwardData,xMin,xMax,yMin,yMax,width,height,"Forward "+title,colour),svg_rev=mismatchPlot(reverseData,xMin,xMax,yMin,yMax,width,height,"Reverse "+title,colour),data.forward_aligned_read_count||(svg_fwd=null),data.reverse_aligned_read_count||(svg_rev=null)}return colour&&(svg_legend=null==svg_fwd&&null==svg_rev?null:draw_legend(height,colour)),oldFormat&&(svg_legend=null),{svg_fwd:svg_fwd,svg_rev:svg_rev,svg_legend:svg_legend}};return{drawChart:drawChart}});