/*! bcviz 1.3.3 - 2021/06/21 13:07:24 GMT+0000 | (c)2021 Genome Research Ltd */

define(["jquery","d3"],function(jQuery,d3){"use strict";function formatMismatch(data){var barData=data.quality_bins,formattedData=[];if(!barData){if(!data.errors)return{formattedData:formattedData,yMax:0};(barData=[])[0]=data.errors,data.n_count=[];for(var k=0;k<data.errors.length;k++)data.n_count[k]=0}barData.push(data.n_count);for(var yMax=0,i=0;i<barData[0].length;i++){for(var yVar=0,pushData=[],total=data.count[i],j=0;j<barData.length;j++)pushData.push({name:data.quality_bin_values[j],y0:yVar/total*100,y1:(barData[j][i]+yVar)/total*100}),yVar+=barData[j][i];pushData[barData.length-1].name="N",formattedData.push(pushData),yMax<yVar/total*100&&(yMax=yVar/total*100)}return{formattedData:formattedData,yMax:yMax}}function mismatchPlot(data,xMin,xMax,xAxis,yAxis,w,h,nodeWidth,colour){var padding_top=50,padding_right=25,padding_bottom=50,padding_left=65,svg=document.createElementNS(d3.ns.prefix.svg,"svg"),svg=d3.select(svg).attr("width",w).attr("height",h);svg.append("text").attr("transform","translate("+padding_left+", "+padding_top/2+")").style("font-size",padding_top/4).text(nodeWidth);var nodeWidth=(w-padding_left-padding_right)/xMax,xScale=d3.scale.linear().nice().range([padding_left,w-padding_right]).domain([xMin,xMax]),yScale=d3.scale.linear().nice().range([h-padding_bottom,padding_top]).domain([xAxis,yAxis]),xAxis=d3.svg.axis().scale(xScale).orient("bottom").ticks(10),yAxis=d3.svg.axis().scale(yScale).orient("left").ticks(10);if(svg.append("g").attr("class","axis").attr("transform","translate("+padding_left+", 0)").call(yAxis),svg.append("g").attr("class","axis").attr("transform","translate(0,"+(h-padding_bottom)+")").call(xAxis),!data.formattedData)return svg;return svg.selectAll(".g").data(data.formattedData).enter().append("g").attr("transform",function(d,i){return"translate("+xScale(i)+",0)"}).selectAll("rect").data(function(d){for(var temp=[],j=0;j<d.length;j++){var obj=d[j];obj.y0-obj.y1!=0&&temp.push(d[j])}return temp}).enter().append("rect").attr("width",nodeWidth).attr("y",function(d){return yScale(d.y1)}).attr("height",function(d){return yScale(d.y0)-yScale(d.y1)}).attr("stroke-width",1).attr("stroke","white").style("fill",function(d){return colour(d.name)}),svg}return{drawChart:function(fwd_xMax){var svg_legend,svg_fwd,reverseData,colour,xMax,svg_rev,data=fwd_xMax.data,width=fwd_xMax.width||450,height=fwd_xMax.height||350,title=fwd_xMax.title||"",oldFormat=!1;return data&&"object"==typeof data&&(xMax={quality_bin_values:data.quality_bin_values},data.forward_aligned_read_count=+data.forward_aligned_read_count,data.reverse_aligned_read_count=+data.reverse_aligned_read_count,svg_fwd=Object.create(xMax),reverseData=Object.create(xMax),svg_fwd.n_count=data.forward_n_count,svg_fwd.quality_bins=data.forward_quality_bins,svg_fwd.count=data.forward_count,svg_fwd.errors=data.forward_errors,reverseData.n_count=data.reverse_n_count,reverseData.quality_bins=data.reverse_quality_bins,reverseData.count=data.reverse_count,reverseData.errors=data.reverse_errors,data.quality_bin_values||(oldFormat=!0,svg_fwd.quality_bin_values=[0],reverseData.quality_bin_values=[0]),(svg_rev=formatMismatch(svg_fwd))&&(svg_fwd.formattedData=svg_rev.formattedData,svg_fwd.yMax=svg_rev.yMax),(colour=formatMismatch(reverseData))&&(reverseData.formattedData=colour.formattedData,reverseData.yMax=colour.yMax),svg_rev&&colour&&(svg_rev.yMax>colour.yMax?(svg_fwd.yMax=svg_rev.yMax,reverseData.yMax=svg_rev.yMax):(svg_fwd.yMax=colour.yMax,reverseData.yMax=colour.yMax)),fwd_xMax=svg_fwd.quality_bins?svg_fwd.quality_bins[0].length:svg_fwd.count?svg_fwd.count.length:0,xMax=reverseData.quality_bins?reverseData.quality_bins[0].length:reverseData.count?reverseData.count.length:0,0,xMax=(xMax=d3.max([fwd_xMax,xMax]))||100,svg_rev=(svg_rev=d3.max([svg_rev.yMax,colour.yMax]))||50,data.quality_bin_values=data.quality_bin_values||[],svg_fwd=mismatchPlot(svg_fwd,0,xMax,0,svg_rev,width,height,"Forward "+title,colour=(oldFormat?d3.scale.ordinal().range(["black","blue"]):d3.scale.ordinal().range(["rgb(8, 18, 247)","rgb(49, 246, 19)","rgb(236, 242, 28)","rgb(219, 68, 0)"])).domain(data.quality_bin_values.concat("N"))),svg_rev=mismatchPlot(reverseData,0,xMax,0,svg_rev,width,height,"Reverse "+title,colour),data.forward_aligned_read_count||(svg_fwd=null),data.reverse_aligned_read_count||(svg_rev=null)),colour&&(svg_legend=null==svg_fwd&&null==svg_rev?null:function(h,colour){var legendPoints=document.createElementNS(d3.ns.prefix.svg,"svg"),legendSVG=d3.select(legendPoints).append("svg").attr("width",50).attr("height",h),legendPoints=legendSVG.selectAll(".legend").data(colour.domain()).enter().append("g").attr("class","legend");return legendPoints.append("rect").attr("y",function(d,i){return 15*i+h/2-30}).attr("width",10).attr("height",10).style("fill",colour),legendPoints.append("text").attr("x",25).attr("y",function(d,i){return 15*i+h/2-30}).attr("dy","10px").style("text-anchor","middle").text(function(d,i){return 0===i?">="+d:1===i||2===i?"=<"+d:d}),legendSVG}(height,colour)),{svg_fwd:svg_fwd,svg_rev:svg_rev,svg_legend:svg_legend=oldFormat?null:svg_legend}}}});